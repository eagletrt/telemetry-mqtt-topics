#ifndef MESSAGE_PARSER_H
#define MESSAGE_PARSER_H

#include <functional>
#include <string>
#include <memory>
#include <unordered_map>

namespace MQTTTopics
{
class MessageParser
{

public:
    typedef std::function<void(const std::string& payload, void*)> parse_t;
    
private:
    class TopicNode
    {
    public:
        TopicNode() = default;

        std::unique_ptr<parse_t> parse;
        void* argument = nullptr;
        std::unordered_map<std::string, std::unique_ptr<TopicNode>> adjacent;
    };

public:
    MessageParser();

    void setMessageParse(const std::string& topic, parse_t parse, void* argument = nullptr);
    void parseMessage(const std::string& topic, const std::string& payload);

private:
    void buildTree();
    void addTopic(std::unique_ptr<TopicNode>& node, const std::string& topic);
    std::unique_ptr<TopicNode>* findNode(std::unique_ptr<TopicNode>& node, const std::string& topic);

    std::unique_ptr<MessageParser::TopicNode> tree;
};
}

#endif