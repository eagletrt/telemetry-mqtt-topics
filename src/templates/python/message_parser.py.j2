from anytree import Node, RenderTree, LevelOrderIter, AsciiStyle, find


class MessageParser:

    def __init__(self):
        self.tree = None
        {% for topic in topics -%}
        self.addNode("{{ topic['topic'] }}",{{(topic['topic']).split("/") | length}})
        {%- if not loop.last%}
        {%endif -%}
        {%- endfor %}

    def addNode(self, topic, layer):
        if topic != "":
            topic_split = topic.split("/")
            if self.tree != None:
                _parent = find(
                    self.tree,
                    lambda node: node.name == topic_split[len(topic_split) - 2]
                    and node.layer == layer - 1,
                )
                Node(
                    topic_split[len(topic_split) - 1],
                    parent=_parent,
                    arg=None,
                    layer=layer,
                    function=None,
                )
            else:
                self.tree = Node(
                    topic_split[len(topic_split) - 1],
                    arg=None,
                    layer=layer,
                    function=None,
                )

    def findNode(self,variables, topic):
        topic_splitWithVariables = topic.split("/")
        hashtag = 3;
        matchV=False
        matchD=False
        matchT=False
        foundT=False
        _node = None
        for i in range(len(topic_splitWithVariables)):
            for node in LevelOrderIter(self.tree, maxlevel=i + 1):
                
                if(node.name == "<vehicleId>"):
                    for var in variables:
                        if(topic_splitWithVariables[i]==var):
                            matchV=True
                    if(not matchV):
                        if("#" in variables and hashtag>0):
                            matchV = True
                            hashtag -=1     
                elif(node.name == "<deviceId>"):
                    for var in variables:
                        if(topic_splitWithVariables[i]==var):
                            matchD=True
                    if(not matchD):
                        if("#" in variables and hashtag>0):
                            matchD = True
                            hashtag -=1 
                elif(node.name == "<transactionId>"):
                    foundT = True
                    for var in variables:
                        if(topic_splitWithVariables[i]==var):
                            matchT=True
                    if(not matchT):
                        if("#" in variables and hashtag>0):
                            matchT = True
                            hashtag -=1 
                else:
                    _node = node

        if(not foundT):
            if(matchV and matchD):
                return _node
            else:
                return None
        else:
            if(matchV and matchD and matchT):
                return _node
            else:
                return None 

    def setMessageParse(self, topic, parse_function, argument):
        _node = self.findNode(["#","#","#"],topic) # ignore varibles
        if _node != None:
            _node.function = parse_function
            _node.arg = argument
    


    
    def parseMessage(self,variables, topic, payload):
        _node = self.findNode(variables,topic)
        if _node != None and _node.function != None and _node.arg != None:
            _node.function(payload, _node.arg)